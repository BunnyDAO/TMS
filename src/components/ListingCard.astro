---
import StatusBadge from './StatusBadge.astro';
import PricingBadge from './PricingBadge.astro';
import { categories, type CategoryKey } from '../data/categories';
import { cardColors, initBgMap } from '../data/cardStyles';

interface Props {
  name: string;
  slug: string;
  tagline: string;
  category: CategoryKey;
  subcategory: string;
  pricing: 'free' | 'freemium' | 'paid' | 'open-source';
  status: 'hot' | 'trending' | 'new' | 'stable';
  website?: string;
  github?: string;
}

const { name, slug, tagline, category, subcategory, pricing, status, website, github } = Astro.props;

const cat = categories[category];
const subName = cat.subcategories[subcategory] || subcategory;

// Extract domain for favicon
let domain = '';
if (website) {
  try { domain = new URL(website).hostname; } catch {}
}

const style = cardColors[cat.color] || cardColors.violet;
const initBg = initBgMap[cat.color] || initBgMap.violet;
const faviconUrl = domain ? `https://www.google.com/s2/favicons?domain=${domain}&sz=128` : '';
---

<a
  href={`/listings/${slug}`}
  class:list={[
    'card-hover group relative flex flex-col overflow-hidden rounded-xl border bg-slate-900/50 p-5 backdrop-blur-sm',
    style.border,
    style.borderHover,
    style.shadow,
    'hover:shadow-lg',
  ]}
>
  {/* Corner glow */}
  <div class:list={['absolute -right-6 -top-6 h-20 w-20 rounded-full opacity-0 blur-2xl transition-opacity group-hover:opacity-20', style.glow]}></div>

  <div class="relative">
    <!-- Header with logo -->
    <div class="mb-3 flex items-start justify-between gap-2">
      <div class="flex items-center gap-2.5">
        {faviconUrl ? (
          <img
            src={faviconUrl}
            alt={`${name} logo`}
            class="h-5 w-5 rounded"
            loading="lazy"
            onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"
          />
          <span class:list={['hidden h-5 w-5 items-center justify-center rounded font-mono text-[10px] font-bold', initBg]}>
            {name.charAt(0)}
          </span>
        ) : (
          <span class:list={['flex h-5 w-5 items-center justify-center rounded font-mono text-[10px] font-bold', initBg]}>
            {name.charAt(0)}
          </span>
        )}
        <h3 class="font-mono text-sm font-bold tracking-tight text-white">{name}</h3>
      </div>
      <StatusBadge status={status} />
    </div>

    <!-- Category + Sub -->
    <div class="mb-3 flex items-center gap-2">
      <span class:list={['inline-block h-1 w-1 rounded-full', style.dot]}></span>
      <span class:list={['font-mono text-[10px]', style.text]}>{cat.name}</span>
      <span class="font-mono text-[10px] text-slate-700">/</span>
      <span class="font-mono text-[10px] text-slate-600">{subName}</span>
    </div>

    <!-- Tagline -->
    <p class="mb-4 flex-1 text-xs leading-relaxed text-slate-500">{tagline}</p>

    <!-- Footer -->
    <div class="flex items-center justify-between">
      <PricingBadge pricing={pricing} />
      <div class="flex items-center gap-2 font-mono text-[10px] text-slate-700">
        {website && (
          <span class="transition-colors group-hover:text-slate-500">web</span>
        )}
        {github && (
          <span class="transition-colors group-hover:text-slate-500">git</span>
        )}
      </div>
    </div>
  </div>
</a>
