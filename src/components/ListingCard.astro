---
import StatusBadge from './StatusBadge.astro';
import PricingBadge from './PricingBadge.astro';
import { categories, type CategoryKey } from '../data/categories';

interface Props {
  name: string;
  slug: string;
  tagline: string;
  category: CategoryKey;
  subcategory: string;
  pricing: 'free' | 'freemium' | 'paid' | 'open-source';
  status: 'hot' | 'trending' | 'new' | 'stable';
  website?: string;
  github?: string;
}

const { name, slug, tagline, category, subcategory, pricing, status, website, github } = Astro.props;

const cat = categories[category];
const subName = cat.subcategories[subcategory] || subcategory;

// Extract domain for favicon
let domain = '';
if (website) {
  try { domain = new URL(website).hostname; } catch {}
}

const cardStyles = {
  violet: {
    border: 'border-violet-500/10',
    borderHover: 'hover:border-violet-500/30',
    shadow: 'hover:shadow-violet-500/10',
    glow: 'bg-violet-500',
    text: 'text-violet-400',
    dot: 'bg-violet-500',
    initBg: 'bg-violet-500/20 text-violet-400',
  },
  orange: {
    border: 'border-orange-500/10',
    borderHover: 'hover:border-orange-500/30',
    shadow: 'hover:shadow-orange-500/10',
    glow: 'bg-orange-500',
    text: 'text-orange-400',
    dot: 'bg-orange-500',
    initBg: 'bg-orange-500/20 text-orange-400',
  },
  blue: {
    border: 'border-blue-500/10',
    borderHover: 'hover:border-blue-500/30',
    shadow: 'hover:shadow-blue-500/10',
    glow: 'bg-blue-500',
    text: 'text-blue-400',
    dot: 'bg-blue-500',
    initBg: 'bg-blue-500/20 text-blue-400',
  },
  teal: {
    border: 'border-teal-400/10',
    borderHover: 'hover:border-teal-400/30',
    shadow: 'hover:shadow-teal-400/10',
    glow: 'bg-teal-400',
    text: 'text-teal-400',
    dot: 'bg-teal-400',
    initBg: 'bg-teal-400/20 text-teal-400',
  },
  emerald: {
    border: 'border-emerald-500/10',
    borderHover: 'hover:border-emerald-500/30',
    shadow: 'hover:shadow-emerald-500/10',
    glow: 'bg-emerald-500',
    text: 'text-emerald-400',
    dot: 'bg-emerald-500',
    initBg: 'bg-emerald-500/20 text-emerald-400',
  },
  cyan: {
    border: 'border-cyan-500/10',
    borderHover: 'hover:border-cyan-500/30',
    shadow: 'hover:shadow-cyan-500/10',
    glow: 'bg-cyan-500',
    text: 'text-cyan-400',
    dot: 'bg-cyan-500',
    initBg: 'bg-cyan-500/20 text-cyan-400',
  },
} as Record<string, Record<string, string>>;

const style = cardStyles[cat.color] || cardStyles.violet;
const faviconUrl = domain ? `https://www.google.com/s2/favicons?domain=${domain}&sz=128` : '';
---

<a
  href={`/listings/${slug}`}
  class:list={[
    'card-hover group relative flex flex-col overflow-hidden rounded-xl border bg-slate-900/50 p-5 backdrop-blur-sm',
    style.border,
    style.borderHover,
    style.shadow,
    'hover:shadow-lg',
  ]}
>
  {/* Corner glow */}
  <div class:list={['absolute -right-6 -top-6 h-20 w-20 rounded-full opacity-0 blur-2xl transition-opacity group-hover:opacity-20', style.glow]}></div>

  <div class="relative">
    <!-- Header with logo -->
    <div class="mb-3 flex items-start justify-between gap-2">
      <div class="flex items-center gap-2.5">
        {faviconUrl ? (
          <img
            src={faviconUrl}
            alt=""
            class="h-5 w-5 rounded"
            loading="lazy"
            onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"
          />
          <span class:list={['hidden h-5 w-5 items-center justify-center rounded font-mono text-[10px] font-bold', style.initBg]}>
            {name.charAt(0)}
          </span>
        ) : (
          <span class:list={['flex h-5 w-5 items-center justify-center rounded font-mono text-[10px] font-bold', style.initBg]}>
            {name.charAt(0)}
          </span>
        )}
        <h3 class="font-mono text-sm font-bold tracking-tight text-white">{name}</h3>
      </div>
      <StatusBadge status={status} />
    </div>

    <!-- Category + Sub -->
    <div class="mb-3 flex items-center gap-2">
      <span class:list={['inline-block h-1 w-1 rounded-full', style.dot]}></span>
      <span class:list={['font-mono text-[10px]', style.text]}>{cat.name}</span>
      <span class="font-mono text-[10px] text-slate-700">/</span>
      <span class="font-mono text-[10px] text-slate-600">{subName}</span>
    </div>

    <!-- Tagline -->
    <p class="mb-4 flex-1 text-xs leading-relaxed text-slate-500">{tagline}</p>

    <!-- Footer -->
    <div class="flex items-center justify-between">
      <PricingBadge pricing={pricing} />
      <div class="flex items-center gap-2 font-mono text-[10px] text-slate-700">
        {website && (
          <span class="transition-colors group-hover:text-slate-500">web</span>
        )}
        {github && (
          <span class="transition-colors group-hover:text-slate-500">git</span>
        )}
      </div>
    </div>
  </div>
</a>
